using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Text.RegularExpressions;
using System.Net;
using System.Xml;
using System.Xml.Serialization;

namespace Schedule_Viewer
{
    public partial class Lookup_Form : Form
    {
        public bool initialized;
        public bool editingForm;
        public int selected_Label_Num;
        List<DropOption> SemesterList;
        List<DropOption> SessionList;
        List<DropOption> CampusList;
        List<DropOption> DistanceList;
        List<DropOption> CollegeList;
        List<DropOption> DepartmentList;
        List<DropOption> StatusList;
        List<DropOption> Status2List;
        List<DropOption> LevelList;
        List<DropOption> TimeList;
        List<DropOption> UGRList;
        List<String> SchedulePages = null;
        public List<Schedule_Record> Schedule;
        DropOption blankOption;
        WebClient webClient;
        int termIndex;

        public void InitializeToolTips()
        {
            System.Windows.Forms.ToolTip DistanceTip = new System.Windows.Forms.ToolTip();
            System.Windows.Forms.ToolTip DistanceComboTip = new System.Windows.Forms.ToolTip();
            DistanceTip.SetToolTip(this.labelDistanceLearning, "Courses offered via alternate teaching methods");
            DistanceComboTip.SetToolTip(this.comboDistanceLearning, "Courses offered via alternate teaching methods");
        }

        public void InitializeLists()
        {
            UTF8Encoding objUTF8;
            String htmlText ="";
            
            try
            {
                webClient = new WebClient();
                const string strUrl = "http://www.registrar.usf.edu/ssearch/staff/staff.php";
                byte[] reqHTML;
                reqHTML = webClient.DownloadData(strUrl);
                objUTF8 = new UTF8Encoding();
                htmlText = objUTF8.GetString(reqHTML);
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
                Application.Exit();
            }


            Regex Semester = new Regex("(?s)<SELECT NAME=\"P_SEMESTER\">(.+?)</SELECT>");
            Regex SemesterOption = new Regex("(?m)(?i)<OPTION VALUE=\"(\\d+)\"[^>]*>(.+?)(<.+)?\n|\r$");
            Regex Session = new Regex("(?s)<SELECT NAME=\"P_SESSION\">(.+?)</SELECT>");
            Regex SessionOption = new Regex("(?m)<OPTION VALUE=\"([A-z])\">(.+)\n|\r$");
            Regex Campus = new Regex("(?s)<SELECT NAME=\"P_CAMPUS\">(.+?)</SELECT>");
            Regex CampusOption = new Regex("(?m)<OPTION VALUE=\"([0-9A-z])\">(.+)\n|\r$");
            Regex Dist = new Regex("(?s)<SELECT NAME=\"P_DIST\">(.+?)</SELECT>");
            Regex DistOption = new Regex("(?m)<OPTION VALUE=\"(\\d)\">(.+)\n|\r$");
            Regex Col = new Regex("(?s)<SELECT NAME=\"P_COL\">(.+?)</SELECT>");
            Regex ColOption = new Regex("(?m)<OPTION VALUE=\"([A-Z][A-Z])\">(.+)\n|\r$");
            Regex Dept = new Regex("(?s)<SELECT NAME=\"P_DEPT\">(.+?)</SELECT>");
            Regex DeptOption = new Regex("(?m)<OPTION VALUE=\"([A-Z]{3})\">(.+)\n|\r$");
            Regex Status = new Regex("(?s)<SELECT NAME=\"p_status\">(.+?)</SELECT>");
            Regex StatusOption = new Regex("(?m)<OPTION VALUE=\"([A-Z])\">(.+)\n|\r$");
            Regex Ssts_code = new Regex("(?s)<SELECT NAME=\"p_ssts_code\">(.+?)</SELECT>");
            Regex Ssts_codeOption = new Regex("(?m)<OPTION VALUE=\"([A-Z])\">(.+)\n|\r$");
            Regex Crse_levl = new Regex("(?s)<SELECT NAME=\"P_CRSE_LEVL\">(.+?)</SELECT>");
            Regex Crse_levlOption = new Regex("(?m)<OPTION VALUE=\"([A-Z]{2})\">(.+)\n|\r$");
            Regex Time1 = new Regex("(?s)<SELECT NAME=\"P_TIME1\">(.+?)</SELECT>");
            Regex Time1Option = new Regex("(?m)(?i)<OPTION VALUE=(\'[0-9]{4}\')>(.+)</option>$");
            Regex Ugr = new Regex("(?s)<SELECT NAME=\"P_UGR\">(.+?)</SELECT>");
            Regex UgrOption = new Regex("(?m)<OPTION VALUE=\"([0-9A-z]{4})\">(.+)\n|\r$");

            blankOption = new DropOption();
            blankOption.description = "";
            blankOption.value = "";

            SemesterList = new List<DropOption>();
            //SemesterList.Add(blankOption);
            foreach (Match m in Semester.Matches(htmlText))
            {
                foreach (Match n in SemesterOption.Matches(m.Groups[1].Value.ToString()))
                {
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboTerm.Items.Add(option);
                    SemesterList.Add(option);
                }
            }

            SessionList = new List<DropOption>();
            //SemesterList.Add(blankOption);
            foreach (Match m in Session.Matches(htmlText))
            {
                foreach (Match n in SessionOption.Matches(m.Groups[1].Value.ToString()))
                {
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboSession.Items.Add(option);
                    SessionList.Add(option);
                }
            }

            CampusList = new List<DropOption>();
            //CampusList.Add(blankOption);
            foreach (Match m in Campus.Matches(htmlText))
            {
                foreach (Match n in CampusOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboCampus.Items.Add(option);
                    SessionList.Add(option);
                }
            }

            DistanceList = new List<DropOption>();
            //DistanceList.Add(blankOption);
            foreach (Match m in Dist.Matches(htmlText))
            {
                foreach (Match n in DistOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboDistanceLearning.Items.Add(option);
                    DistanceList.Add(option);
                }
            }

            CollegeList = new List<DropOption>();
            //CollegeList.Add(blankOption);
            foreach (Match m in Col.Matches(htmlText))
            {
                foreach (Match n in ColOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboCollege.Items.Add(option);
                    CollegeList.Add(option);
                }
            }

            DepartmentList = new List<DropOption>();
            //DepartmentList.Add(blankOption);
            foreach (Match m in Dept.Matches(htmlText))
            {
                foreach (Match n in DeptOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboDepartment.Items.Add(option);
                    DepartmentList.Add(option);
                }
            }

            StatusList = new List<DropOption>();
            //StatusList.Add(blankOption);
            foreach (Match m in Status.Matches(htmlText))
            {
                foreach (Match n in StatusOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboStatus.Items.Add(option);
                    StatusList.Add(option);
                }
            }

            Status2List = new List<DropOption>();
            //Status2List.Add(blankOption);
            foreach (Match m in Ssts_code.Matches(htmlText))
            {
                foreach (Match n in Ssts_codeOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboStatus2.Items.Add(option);
                    Status2List.Add(option);
                }
            }

            LevelList = new List<DropOption>();
            //LevelList.Add(blankOption);
            foreach (Match m in Crse_levl.Matches(htmlText))
            {
                foreach (Match n in Crse_levlOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboLevel.Items.Add(option);
                    LevelList.Add(option);
                }
            }

            TimeList = new List<DropOption>();
            //TimeList.Add(blankOption);
            foreach (Match m in Time1.Matches(htmlText))
            {
                //MessageBox.Show(m.Groups[0].Value.ToString());
                foreach (Match n in Time1Option.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboTime.Items.Add(option);
                    TimeList.Add(option);
                }
            }

            UGRList = new List<DropOption>();
            //UGRList.Add(blankOption);
            foreach (Match m in Ugr.Matches(htmlText))
            {
                foreach (Match n in UgrOption.Matches(m.Groups[1].Value.ToString()))
                {
                    //MessageBox.Show(n.Groups[1].Value.ToString());
                    DropOption option = new DropOption();
                    option.value = n.Groups[1].Value.ToString();
                    option.description = n.Groups[2].Value.ToString();
                    comboUGR.Items.Add(option);
                    UGRList.Add(option);
                }
            }

            comboCampus.Items.RemoveAt(0);
            comboCollege.Items.RemoveAt(0);
            comboDepartment.Items.RemoveAt(0);
            comboDistanceLearning.Items.RemoveAt(0);
            comboLevel.Items.RemoveAt(0);
            comboSession.Items.RemoveAt(0);
            comboStatus.Items.RemoveAt(0);
            comboStatus2.Items.RemoveAt(0);
            comboTerm.Items.RemoveAt(0);
            comboTime.Items.RemoveAt(0);
            comboUGR.Items.RemoveAt(0);
            comboCampus.Items.Insert(0, blankOption);
            comboCollege.Items.Insert(0, blankOption);
            comboDepartment.Items.Insert(0, blankOption);
            comboDistanceLearning.Items.Insert(0, blankOption);
            comboLevel.Items.Insert(0, blankOption);
            comboSession.Items.Insert(0, blankOption);
            comboStatus.Items.Insert(0, blankOption);
            comboStatus2.Items.Insert(0, blankOption);
            comboTerm.Items.Insert(0, blankOption);
            comboTime.Items.Insert(0, blankOption);
            comboUGR.Items.Insert(0, blankOption);

            String timeString;
            int timeYear = DateTime.Now.Year;
            int month = DateTime.Now.Month;

            if (month <= 5)
            {
                timeString = timeYear.ToString() + "05";
            }
            else if (month <= 08)
            {
                timeString = timeYear.ToString() + "08";
            }
            else
            {
                timeYear++;
                timeString = timeYear.ToString() + "01";
            }
            comboCampus.SelectedIndex = 0;
            comboCollege.SelectedIndex = 0;
            comboDepartment.SelectedIndex = 0;
            comboDistanceLearning.SelectedIndex = 0;
            comboLevel.SelectedIndex = 0;
            comboSession.SelectedIndex = 0;
            comboStatus.SelectedIndex = 1; // Default to selected Open
            comboStatus2.SelectedIndex = 1; // Default to selected Active
            comboTerm.SelectedIndex = 0;
            foreach(DropOption checkTime in comboTerm.Items){
                if (checkTime.value == timeString)
                    comboTerm.SelectedItem = checkTime;
            }
            comboTime.SelectedIndex = 0;
            comboUGR.SelectedIndex = 0;

            termIndex = comboTerm.SelectedIndex;


            Schedule = new List<Schedule_Record>();
            initialized = true;
        }

        public Lookup_Form()
        {
            InitializeComponent();
            InitializeToolTips();
            if (!initialized)
                InitializeLists();
            buttonEdit.Enabled = false;
            buttonRemove.Enabled = false;
            buttonClear.Enabled = false;


            //SemesterValues.Add();
        }

        public void clearItems()
        {
            textCRN.Text = String.Empty;
            textHours.Text = String.Empty;
            textInstructor.Text = String.Empty;
            textLabel.Text = String.Empty;
            textNumber.Text = String.Empty;
            textSubject.Text = String.Empty;
            textTitle.Text = String.Empty;

            checkFri1.Checked = false;
            checkFri2.Checked = false;
            checkMon1.Checked = false;
            checkMon2.Checked = false;
            checkSat1.Checked = false;
            checkSat2.Checked = false;
            checkSun1.Checked = false;
            checkSun2.Checked = false;
            checkThurs1.Checked = false;
            checkThurs2.Checked = false;
            checkTues1.Checked = false;
            checkTues2.Checked = false;
            checkWed1.Checked = false;
            checkWed2.Checked = false;

            comboCampus.SelectedIndex = 0;
            comboCollege.SelectedIndex = 0;
            comboDepartment.SelectedIndex = 0;
            comboDistanceLearning.SelectedIndex = 0;
            comboLevel.SelectedIndex = 0;
            comboSession.SelectedIndex = 0;
            comboStatus.SelectedIndex = 1;
            comboStatus2.SelectedIndex = 1;
            comboTerm.SelectedIndex = termIndex;
            comboTime.SelectedIndex = 0;
            comboUGR.SelectedIndex = 0;
        }


        private void buttonClearForm_Click(object sender, EventArgs e)
        {
            clearItems();
        }

        private void buttonAdd_Click(object sender, EventArgs e)
        {
            if (textLabel.TextLength == 0)
            {
                MessageBox.Show("A label for this class search is required.");
                return;
            }
            if (comboTerm.SelectedIndex == 0)
            {
                MessageBox.Show("Please select a term for this class search.");
                return;
            }
            if (!editingForm)
            {
                foreach(Schedule_Search item in listLabels.Items){
                    String label = item.Label;
                    if(label.Equals(textLabel.Text)){
                        MessageBox.Show("Label " + textLabel.Text + " already exists in the list, please choose another label.");
                        return;
                    }
                }
                Schedule_Search newSchedule = new Schedule_Search(textLabel.Text, textCRN.Text, textSubject.Text,
                    textNumber.Text, textHours.Text, textTitle.Text, textInstructor.Text, (DropOption)comboTerm.SelectedItem,
                    (DropOption)comboSession.SelectedItem, (DropOption)comboCampus.SelectedItem,
                    (DropOption)comboDistanceLearning.SelectedItem, (DropOption)comboCollege.SelectedItem,
                    (DropOption)comboDepartment.SelectedItem, (DropOption)comboStatus.SelectedItem,
                    (DropOption)comboStatus2.SelectedItem, (DropOption)comboLevel.SelectedItem,
                    (DropOption)comboTime.SelectedItem, (DropOption)comboUGR.SelectedItem, checkFri1.Checked,
                    checkFri2.Checked, checkMon1.Checked, checkMon2.Checked, checkSat1.Checked, checkSat2.Checked,
                    checkSun1.Checked, checkSun2.Checked, checkThurs1.Checked, checkThurs2.Checked, checkTues1.Checked,
                    checkTues2.Checked, checkWed1.Checked, checkWed2.Checked);
                listLabels.Items.Add(newSchedule);
            }
            else
            {
                Schedule_Search editSearch = (Schedule_Search)listLabels.Items[selected_Label_Num];
                editSearch.EditSearch(textLabel.Text, textCRN.Text, textSubject.Text,
                textNumber.Text, textHours.Text, textTitle.Text, textInstructor.Text, (DropOption)comboTerm.SelectedItem,
                (DropOption)comboSession.SelectedItem, (DropOption)comboCampus.SelectedItem,
                (DropOption)comboDistanceLearning.SelectedItem, (DropOption)comboCollege.SelectedItem,
                (DropOption)comboDepartment.SelectedItem, (DropOption)comboStatus.SelectedItem,
                (DropOption)comboStatus2.SelectedItem, (DropOption)comboLevel.SelectedItem,
                (DropOption)comboTime.SelectedItem, (DropOption)comboUGR.SelectedItem, checkFri1.Checked,
                checkFri2.Checked, checkMon1.Checked, checkMon2.Checked, checkSat1.Checked, checkSat2.Checked,
                checkSun1.Checked, checkSun2.Checked, checkThurs1.Checked, checkThurs2.Checked, checkTues1.Checked,
                checkTues2.Checked, checkWed1.Checked, checkWed2.Checked);
                editingForm = false;
                buttonAdd.Text = "Add to List";
                textLabel.Enabled = true;
            }
            buttonSearch.Enabled = true;
            int selectedTerm = comboTerm.SelectedIndex; // hold the selected term, in case user is wanting to use a different term
            clearItems();
            comboTerm.SelectedIndex = selectedTerm; // set back to user-selected term after clear
            textLabel.Text = String.Empty;
        }

        private void buttonClear_Click(object sender, EventArgs e)
        {
            if (listLabels.Items.Count != 0)
            {
                listLabels.Items.Clear();
            }
            editingForm = false;
            buttonEdit.Enabled = false;
            buttonRemove.Enabled = false;
            buttonClear.Enabled = false;
            MessageBox.Show("List cleared");
            buttonAdd.Text = "Add To List";
        }

        private void buttonRemove_Click(object sender, EventArgs e)
        {
            DialogResult areYouSure = MessageBox.Show("Are you sure you want to remove that item?", "Warning", MessageBoxButtons.YesNo);
            if (areYouSure == DialogResult.Yes)
            {
                listLabels.Items.Remove(listLabels.SelectedItem);
            }
            if (listLabels.Items.Count == 0)
                buttonSearch.Enabled = false;
        }

        private void buttonEdit_Click(object sender, EventArgs e)
        {
            Schedule_Search selected_Label = (Schedule_Search)listLabels.SelectedItem;
            selected_Label_Num = listLabels.SelectedIndex;
            editingForm = true;
            buttonAdd.Text = "Save edited item";
            textLabel.Enabled = false;

            textCRN.Text = selected_Label.CRN;
            textHours.Text = selected_Label.Hours;
            textInstructor.Text = selected_Label.Instructor;
            textLabel.Text = selected_Label.Label;
            textNumber.Text = selected_Label.Number;
            textSubject.Text = selected_Label.Subject;
            textTitle.Text = selected_Label.Title;

            checkFri1.Checked = selected_Label.CheckFri1;
            checkFri2.Checked = selected_Label.CheckFri2;
            checkMon1.Checked = selected_Label.CheckMon1;
            checkMon2.Checked = selected_Label.CheckMon2;
            checkSat1.Checked = selected_Label.CheckSat1;
            checkSat2.Checked = selected_Label.CheckSat2;
            checkSun1.Checked = selected_Label.CheckSun1;
            checkSun2.Checked = selected_Label.CheckSun2;
            checkThurs1.Checked = selected_Label.CheckThurs1;
            checkThurs2.Checked = selected_Label.CheckThurs2;
            checkTues1.Checked = selected_Label.CheckTues1;
            checkTues2.Checked = selected_Label.CheckTues2;
            checkWed1.Checked = selected_Label.CheckWed1;
            checkWed2.Checked = selected_Label.CheckWed2;

            comboCampus.SelectedItem = selected_Label.Campus;
            comboCollege.SelectedItem = selected_Label.Col;
            comboDepartment.SelectedItem = selected_Label.Dept;
            comboDistanceLearning.SelectedItem = selected_Label.Dist;
            comboLevel.SelectedItem = selected_Label.Crse_levl;
            comboSession.SelectedItem = selected_Label.Session;
            comboStatus.SelectedItem = selected_Label.Status;
            comboStatus2.SelectedItem = selected_Label.Ssts_code;
            comboTerm.SelectedItem = selected_Label.Semester;
            comboTime.SelectedItem = selected_Label.Time1;
            comboUGR.SelectedItem = selected_Label.Ugr;
        }

        public void WebSearch()
        {
            NameValueCollection collection = new NameValueCollection();
            bool no_check = true;
            foreach (Schedule_Search search in listLabels.Items)
            {
                collection.Add("P_SEMESTER", search.Semester.value);
                collection.Add("P_SESSION", search.Session.value);
                collection.Add("P_CAMPUS", search.Campus.value);
                collection.Add("P_DIST", search.Dist.value);
                collection.Add("P_COL", search.Col.value);
                collection.Add("P_DEPT", search.Dept.value);
                collection.Add("p_status", search.Status.value);
                collection.Add("p_ssts_code", search.Ssts_code.value);
                collection.Add("P_CRSE_LEVL", search.Crse_levl.value);
                collection.Add("P_REF", search.CRN);
                collection.Add("P_SUBJ", search.Subject);
                collection.Add("P_NUM", search.Number);
                collection.Add("P_TITLE", search.Title);
                collection.Add("P_CR", search.Hours);
                if (search.CheckMon1)
                {
                    collection.Add("p_day_x", "M");
                    no_check = false;
                }
                if (search.CheckTues1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "T");
                }
                if (search.CheckWed1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "W");
                }
                if (search.CheckThurs1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "R");
                }
                if (search.CheckFri1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "F");
                }
                if (search.CheckSat1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "S");
                }
                if (search.CheckSun1)
                {
                    no_check = false;
                    collection.Add("p_day_x", "U");
                }
                if (no_check)
                    collection.Add("p_day_x", "no_val");

                no_check = true;
                if (search.CheckMon2)
                {
                    collection.Add("p_day", "M");
                    no_check = false;
                }
                if (search.CheckTues2)
                {
                    no_check = false;
                    collection.Add("p_day", "T");
                }
                if (search.CheckWed2)
                {
                    no_check = false;
                    collection.Add("p_day", "W");
                }
                if (search.CheckThurs2)
                {
                    no_check = false;
                    collection.Add("p_day", "R");
                }
                if (search.CheckFri2)
                {
                    no_check = false;
                    collection.Add("p_day", "F");
                }
                if (search.CheckSat2)
                {
                    no_check = false;
                    collection.Add("p_day", "S");
                }
                if (search.CheckSun2)
                {
                    no_check = false;
                    collection.Add("p_day", "U");
                }
                if (no_check)
                    collection.Add("p_day", "no_val");
                no_check = true;
                collection.Add("P_TIME1", search.Time1.value);
                collection.Add("P_INSTRUCTOR", search.Instructor);
                collection.Add("P_UGR", search.Ugr.value);
                webClient.Headers.Add("Referer", "http://www.registrar.usf.edu/ssearch/staff/staff.php");
                byte[] responseArray = webClient.UploadValues("http://usfonline.admin.usf.edu/pls/prod/wp_staff_search_db", "post", collection);
                SchedulePages.Add(Encoding.ASCII.GetString(responseArray));
                collection.Clear();
            }
        }

        public void FactorPage(String page){
            Regex Table = new Regex("(?s)<TABLE CELLSPACING=\"0\" CELLSPADDING=\"0\" BORDER=\"1\" WIDTH=\"100%\">(.+?)</TABLE>");
            Regex Rows = new Regex("(?s)<(TR|TR BORDERCOLOR=\"#C0C0C0\" BGCOLOR=\"#C0C0C0\")>(.+?)</TR>");
            //Regex Item = new Regex("(?m)(?i)<(?:TD)[^>]+>([^>]+)?(?:<A[^>]+>)*([^>]+|)(?:<\\/A>)*([^>]+|)?<\\/(?:TD)>"); // Thanks to Aaron Kalin
            Regex Item = new Regex("(?s)(?i)<TD[^>]+>(.*?)</TD>");
            Regex Subj = new Regex("(?s)(?i)<A[^>]+>(.*?)</A>");

            page = page.Replace("<BR>", "\n");
            page = page.Replace("&nbsp;", " ");

            List<String> Items = new List<string>();

            foreach(Match m in Table.Matches(page)){
                foreach(Match n in Rows.Matches(m.Groups[1].Value.ToString())){
                    foreach(Match o in Item.Matches(n.Groups[2].Value.ToString())){
                        Items.Add(o.Groups[1].Value.ToString());
                    }

                    Match subjChange = Subj.Match(Items[4]);
                    Items[4] = subjChange.Groups[1].Value.ToString();
                    if(Items[7].Contains("<A")){
                        Regex removeLink = new Regex("(?s)([^<]+(<A[^>]+>).*?(</A>))");
                        MatchCollection linkMatch = removeLink.Matches(Items[7]);
                        foreach(Match i in linkMatch){
                            String sMatch = i.Groups[2].Value.ToString();
                            Items[7] = Items[7].Replace(sMatch, "");
                        }
                        Items[7] = Items[7].Replace("</A>","");
                    }
                    if (Items[7].Contains("<a"))
                    {
                        Regex removeLink = new Regex("(?s)([^<]+(<a[^>]+>).*?(</a>))");
                        MatchCollection linkMatch = removeLink.Matches(Items[7]);
                        foreach (Match i in linkMatch)
                        {
                            String sMatch = i.Groups[2].Value.ToString();
                            Items[7] = Items[7].Replace(sMatch, "");
                        }
                        Items[7] = Items[7].Replace("</a>", "");
                    }

                    Schedule_Record newRecord = new Schedule_Record(Items);
                    Items.Clear();
                    if(!newRecord.Error_Detected())
                        Schedule.Add(newRecord);
                }
            }

        }


        private void buttonSearch_Click(object sender, EventArgs e)
        {
            if (SchedulePages == null)
                SchedulePages = new List<string>();
            else
            {
                SchedulePages.Clear();
            }
            WebSearch();

            foreach (String page in SchedulePages)
            {
                FactorPage(page);
            }


            Schedule.Sort(new ScheduleDayComparer());
            Schedule.Sort();
            //bool clearMe = false;
            Schedule_Viewer.Form1 form1 = new Schedule_Viewer.Form1(Schedule);
            //form1.Show();
            form1.Show(this);
            form1.BringToFront();
            listLabels.Items.Clear();
            Schedule.Clear();
        }

        private void Lookup_Form_Load(object sender, EventArgs e)
        {

        }

        private void listLabels_SelectedIndexChanged(object sender, EventArgs e)
        {
            buttonEdit.Enabled = true;
            buttonRemove.Enabled = true;
            buttonClear.Enabled = true;
        }

        /* private void button5_Click(object sender, EventArgs e)
         {

         }*/
    }
}
